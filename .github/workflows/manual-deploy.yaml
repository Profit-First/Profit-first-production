# Manual Deployment Workflow
# Allows manual deployment of specific version to specific environment

name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Image tag (leave empty for latest)'
        required: false
        type: string

env:
  AWS_REGION: ap-south-1

jobs:
  deploy:
    name: Manual Deployment
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # Step 3: Login to Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      # Step 4: Deploy backend
      - name: Deploy backend
        if: inputs.service == 'backend' || inputs.service == 'both'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deploying backend with tag: $IMAGE_TAG"
          sed -i "s|image: .*profit-first-backend.*|image: $ECR_REGISTRY/profit-first-backend:$IMAGE_TAG|g" k8s/backend/backend-deployment.yaml
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/backend/backend-deployment.yaml
          git commit -m "Manual: backend $IMAGE_TAG to ${{ inputs.environment }} [skip ci]" || echo "No changes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main || echo "Nothing to push"
      
      # Step 5: Deploy frontend
      - name: Deploy frontend
        if: inputs.service == 'frontend' || inputs.service == 'both'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deploying frontend with tag: $IMAGE_TAG"
          sed -i "s|image: .*profit-first-frontend.*|image: $ECR_REGISTRY/profit-first-frontend:$IMAGE_TAG|g" k8s/frontend/frontend-deployment.yaml
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/frontend/frontend-deployment.yaml
          git commit -m "Manual: frontend $IMAGE_TAG to ${{ inputs.environment }} [skip ci]" || echo "No changes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main || echo "Nothing to push"
      
      # Step 6: Summary
      - name: Deployment summary
        run: |
          echo "âœ… Manual deployment complete!"
          echo "Service: ${{ inputs.service }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Image tag: ${{ inputs.image_tag || 'latest' }}"
          echo "ArgoCD will sync the changes automatically"
